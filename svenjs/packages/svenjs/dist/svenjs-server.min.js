!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("stream")):"function"==typeof define&&define.amd?define(["stream"],e):t.InfernoServer=e(t.stream)}(this,function(t){"use strict";function e(t,e){if(!o(t)){var r=n(t);(r&&t.length>0||!r)&&(e=e?Object.assign({},e,{children:t}):{children:t})}return e}function n(t){return t instanceof Array}function r(t){return t.prototype&&void 0!==t.prototype.render}function i(t){return l(t)||a(t)}function o(t){return p(t)||c(t)}function s(t){return c(t)||t===!1||t===!0||p(t)}function u(t){return"function"==typeof t}function l(t){return"string"==typeof t}function a(t){return"number"==typeof t}function c(t){return null===t}function h(t){return t===!0}function p(t){return void 0===t}function d(){this._listeners=[],this.scrollX=null,this.scrollY=null,this.screenHeight=T,this.screenWidth=A}function f(t){this.bp=t,this.dom=null,this.instance=null,this.tag=null,this.children=null,this.style=null,this.className=null,this.attrs=null,this.events=null,this.hooks=null,this.key=null,this.clipData=null}function g(t,e,n){t.split(",").forEach(function(t){return e[t]=n})}function m(t){return(t+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/\//g,"&#x2F;")}function w(t){return(t+"").replace(/&/g,"&amp;").replace(/"/g,"&quot;")}function y(t){return t.replace(/([a-zA-Z])(?=[A-Z])/g,"$1-").toLowerCase()}function v(t){return!!q[t]}function x(t,n,i,s,u){if(n=e(i,n),r(t)){var l=new t(n,s),a=l.getChildContext();o(a)||(s=Object.assign({},s,a)),l.context=s,l._pendingSetState=!0,l.componentWillMount();var c=l.render();return l._pendingSetState=!1,S(c,s,u)}return S(t(n,s),s,u)}function k(t,e){if(t&&n(t)){for(var r=[],o=!1,u=0;u<t.length;u++){var l=t[u],a=i(l),c=s(l);a||c?(o===!0&&(s(l)?r.push("<!--!-->"):r.push("<!---->")),a&&r.push(m(l)),o=!0):n(l)?(r.push("<!---->"),r.push(k(l)),r.push("<!--!-->"),o=!0):(o=!1,r.push(S(l,e,!1)))}return r.join("")}return s(t)?"":i(t)?m(t):S(t,e,!1)||""}function b(t){if(i(t))return t;for(var e=[],n=Object.keys(t),r=0;r<n.length;r++){var s=n[r],u=t[s],l=a(u)&&!Y[s]?"px":"";o(u)||e.push(y(s)+":"+w(u)+l+";")}return e.join("")}function S(t,e,n){if(!s(t)){var r=t.bp,l=t.tag||r&&r.tag,a=[],c=t.className,p=t.style;if(u(l))return x(l,t.attrs,t.children,e,n);o(c)||a.push('class="'+w(c)+'"'),o(p)||a.push('style="'+b(p)+'"');var d=t.attrs,f=d&&Object.keys(d)||[],g="";return r&&r.hasAttrs===!0&&(f=r.attrKeys?r.attrKeys.concat(f):f),f.forEach(function(t,e){var n=f[e],r=d[n];"dangerouslySetInnerHTML"===n?g=r.__html:i(r)?a.push(w(n)+'="'+w(r)+'"'):h(r)&&a.push(w(n))}),n&&a.push("data-sjsroot"),v(l)?"<"+l+(a.length>0?" "+a.join(" "):"")+">":"<"+l+(a.length>0?" "+a.join(" "):"")+">"+(g||k(t.children,e))+"</"+l+">"}}function j(t){return S(t,null,!1)}function _(t){return S(t,null,!0)}function C(t){if(i(t))return t;for(var e=[],n=Object.keys(t),r=0;r<n.length;r++){var s=n[r],u=t[s],l=a(u)&&!Y[s]?"px":"";o(u)||e.push(y(s)+":"+w(u)+l+";")}return e.join()}function N(t,e){var n=[],r=e&&Object.keys(e)||[];return t&&t.hasAttrs===!0&&(r=t.attrKeys?t.attrKeys.concat(r):r),r.forEach(function(t,o){var s=r[o],u=e[s];"dangerouslySetInnerHTML"!==s&&(i(u)?n.push(w(s)+'="'+w(u)+'"'):isTrue(u)&&n.push(w(s)))}),n}function M(t){return new D(t,!1)}function O(t){return new D(t,!0)}var I="undefined"!=typeof window&&window.document,A=I&&window.screen.width,T=I&&window.screen.height,H=0,L=0,P=0;I&&(window.onscroll=function(){H=window.scrollX,L=window.scrollY,P=performance.now()},window.resize=function(){H=window.scrollX,L=window.scrollY,A=window.screen.width,T=window.screen.height,P=performance.now()}),d.prototype={refresh:function(){this.scrollX=I&&window.scrollX,this.scrollY=I&&window.scrollY},addListener:function(t){this._listeners.push(t)},trigger:function(){for(var t=this,e=0;e<this._listeners.length;e++)t._listeners[e]()}};new Map;f.prototype={setAttrs:function(t){return this.attrs=t,this},setTag:function(t){return this.tag=t,this},setStyle:function(t){return this.style=t,this},setClassName:function(t){return this.className=t,this},setChildren:function(t){return this.children=t,this},setHooks:function(t){return this.hooks=t,this},setEvents:function(t){return this.events=t,this},setKey:function(t){return this.key=t,this}};var W=(I?document.body:null,new Map,new Map,"http://www.w3.org/1999/xlink"),X="http://www.w3.org/XML/1998/namespace",z={},E={},K={},Y={};g("xlink:href,xlink:arcrole,xlink:actuate,xlink:role,xlink:titlef,xlink:type",K,W),g("xml:base,xml:lang,xml:space",K,X),g("volume,value",z,!0),g("muted,scoped,loop,open,checked,default,capture,disabled,selected,readonly,multiple,required,autoplay,controls,seamless,reversed,allowfullscreen,novalidate",E,!0),g("animationIterationCount,borderImageOutset,borderImageSlice,borderImageWidth,boxFlex,boxFlexGroup,boxOrdinalGroup,columnCount,flex,flexGrow,flexPositive,flexShrink,flexNegative,flexOrder,gridRow,gridColumn,fontWeight,lineClamp,lineHeight,opacity,order,orphans,tabSize,widows,zIndex,zoom,fillOpacity,floodOpacity,stopOpacity,strokeDasharray,strokeDashoffset,strokeMiterlimit,strokeOpacity,strokeWidth,",Y,!0);var q={area:!0,base:!0,br:!0,col:!0,command:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0},D=function(t){function l(e,n){t.call(this),this.initNode=e,this.staticMarkup=n,this.started=!1}return t&&(l.__proto__=t),l.prototype=Object.create(t&&t.prototype),l.prototype.constructor=l,l.prototype._read=function(){var t=this;this.started||(this.started=!0,Promise.resolve().then(function(){return t.renderNode(t.initNode,null,t.staticMarkup)}).then(function(){t.push(null)}).catch(function(e){t.emit("error",e)}))},l.prototype.renderNode=function(t,e,n){if(!s(t)){var r=t.bp,i=t.tag||r&&r.tag;return u(i)?this.renderComponent(i,t.attrs,t.children,e,n):this.renderNative(i,t,e,n)}},l.prototype.renderComponent=function(t,n,i,s,u){var l=this;if(n=e(i,n),!r(t))return this.renderNode(t(n,s),s,u);var a=new t(n,s),c=a.getChildContext();return o(c)||(s=Object.assign({},s,c)),a.context=s,a._pendingSetState=!0,Promise.resolve(a.componentWillMount()).then(function(){var t=a.render();return a._pendingSetState=!1,l.renderNode(t,s,u)})},l.prototype.renderChildren=function(t,e){var r=this;if(i(t))return this.push(m(t));if(t){var o=n(t);if(!o&&!s(t))return this.renderNode(t,e,!1);if(!o)throw new Error("invalid component");return t.reduce(function(t,o){return t.then(function(t){var u=i(o),l=s(o);return u||l?(t===!0&&(l?r.push("<!--!-->"):r.push("<!---->")),u&&r.push(m(o)),!0):n(o)?(r.push("<!---->"),Promise.resolve(r.renderChildren(o)).then(function(){return r.push("<!--!-->"),!0})):r.renderNode(o,e,!1).then(function(){return!1})})},Promise.resolve(!1))}},l.prototype.renderNative=function(t,e,n,r){var i=this,s=e.bp,u=e.attrs,l=e.className,a=e.style,c=N(s,u);o(l)||c.push('class="'+w(l)+'"'),o(a)||c.push('style="'+C(a)+'"');var h="";if(u&&"dangerouslySetInnerHTML"in u&&(h=u.dangerouslySetInnerHTML.__html),r&&c.push("data-sjsroot"),this.push("<"+t+(c.length>0?" "+c.join(" "):"")+">"),!v(t))return h?(this.push(h),void this.push("</"+t+">")):Promise.resolve(this.renderChildren(e.children,n)).then(function(){i.push("</"+t+">")})},l}(t.Readable),F={renderToString:j,renderToStaticMarkup:_,streamAsString:M,streamAsStaticMarkup:O,RenderStream:D};return F});
